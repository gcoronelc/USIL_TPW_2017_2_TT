CREATE VIEW V_RESUMEN_CURSO(
	PERIODO, CICLO, TARIFA, NOMTARIFA, CURSO, NOMCURSO, HORAS, PRECIO, PAGOHORA,
	SECCIONES, VACANTES, MATRICULADOS, DISPONIBLES, INGRESOS, PAGOPROF, UTILIDAD
) AS
WITH V_PREVIA AS(
	SELECT 
		LEFT(IdCiclo,4) PERIODO,
		IdCiclo, IdCurso,
		COUNT(IDCURSOPROG) SECCIONES,
		SUM(Vacantes + Matriculados) VACANTES,
		SUM(Vacantes) DISPONIBLES,
		SUM(Matriculados) MATRICULADOS,
		SUM(Matriculados * PreCursoProg) INGRESOS
	FROM DBO.CursoProgramado
	WHERE Activo = 1
	GROUP BY IdCiclo, IdCurso)
SELECT 
	V.PERIODO,V.IdCiclo, T.IdTarifa, T.Descripcion, C.IdCurso, C.NomCurso,	T.Horas, 
	T.PrecioVenta, T.PagoHora, V.SECCIONES, V.VACANTES, V.MATRICULADOS, V.DISPONIBLES, V.INGRESOS, 
	(T.Horas * T.PagoHora * V.SECCIONES) PAGOPROF,
	(V.INGRESOS - (T.Horas * T.PagoHora * V.SECCIONES)) UTILIDAD
FROM DBO.Tarifa T
JOIN DBO.Curso C ON T.IdTarifa = C.IdTarifa
JOIN V_PREVIA V ON C.IdCurso = V.IdCurso
JOIN DBO.Ciclo CI ON V.IdCiclo = CI.IdCiclo;
GO


 
 SELECT *
 FROM V_RESUMEN_CURSO
 WHERE PERIODO='2017' AND CICLO = '2017-02'
 ORDER BY CURSO;
 GO


 SELECT *
 FROM V_RESUMEN_CURSO
 WHERE Ciclo = '2017-02' ;
